---
name: Build

on:
  - push

jobs:
  # build_container:
  #   name: Build container
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checking out code from GitHub
  #       uses: actions/checkout@v2

  #     - name: Get Time
  #       id: time
  #       uses: nanzm/get-time-action@v1.1
  #       with:
  #         format: "YYYY.MM.DD"

  #     - name: Authenticate at ghcr.io
  #       run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u USERNAME --password-stdin

  #     - name: Build container
  #       run: docker build -t "ghcr.io/zhulik/arch_builder" .

  #     - name: Push container
  #       env:
  #         VERSION: "${{ steps.time.outputs.time }}"
  #       run: |
  #         docker tag "ghcr.io/zhulik/arch_builder" "ghcr.io/zhulik/arch_builder:$VERSION"
  #         docker push "ghcr.io/zhulik/arch_builder:latest"
  #         docker push "ghcr.io/zhulik/arch_builder:$VERSION"

  build_package:
    name: Build package
    runs-on: ubuntu-latest
    # needs:
    #   - build_container
    strategy:
      matrix:
        package: ["package-query"]
    steps:
      - uses: actions/checkout@v2

      - name: Authenticate at ghcr.io
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u USERNAME --password-stdin

      - name: Get latest version
        id: version_step
        run: echo "::set-output name=version::$(docker-compose run arch_builder pikaur -Si ${{ matrix.package }} | grep Version | cut -d' ' -f11)"

      - name: Print latest version
        run: echo ${{ steps.version_step.outputs.version }}

      - name: Cache package and dependencies
        id: cache
        uses: actions/cache@v3
        with:
          path: cache
          key: ${{ matrix.package }}-v1-${{ steps.version_step.outputs.version }}
          restore-keys: |
            ${{ matrix.package }}-

      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          chmod -R 777 cache
          docker-compose run arch_builder build.rb ${{ matrix.package }}
          sudo chmod -R 777 cache
